# Session 2025-10-06: Chart Screenshot Export Issue Investigation

**Date**: 2025-10-06
**Duration**: ~30 minutes
**Focus**: Screenshot save margin issue debugging

---

## 🎯 Session Goal

**User Issue**: "save버튼을 눌러서 사진저장할 때 Rx Out1 이쪽이 마진이 없어서 왼쪽 부분이 짤린다"

When using the "Save PNG" button in the chart viewer, RXOUT labels on the left side are being cropped/cut off in the exported image.

---

## 🔍 Problem Analysis

### Current Chart Setup
- **Chart Size**: 1500px width × 900px height
- **Left Margin**: 200px
- **RXOUT Label Position**: `x=-0.08` (8% left of subplot edge)
- **Export Settings**: `Plotly.downloadImage('chart', {format: 'png', width: 1920, height: 1200})`

### Root Cause Investigation

**Initial Hypothesis**: Export width too small
- Attempted: Increase width from 1920 to 2000px
- Result: ❌ Failed - Image scales proportionally, cropping position unchanged

**User Feedback**: "비율에 맞게 늘어나고 잘리는 위치는 변경이 없는것 같아"

**Deeper Analysis**:
The real issue is that RXOUT annotations are positioned using:
- `x=-0.08` (negative coordinate = outside subplot domain)
- Default `xref='x domain'` (subplot-relative coordinates)
- Plotly's `downloadImage()` may not capture annotations outside subplot bounds

**Attempted Fix**: Change annotation `xref` to `'paper'`
- Rationale: Paper coordinates include margin area
- Implementation: Added `xref="paper"` to annotation.update()
- Result: ❌ Failed - Still cropped

---

## ⚠️ Important Lesson Learned

**User's Critical Instruction**:
> "코드 수정했는데 문제 해결안되면 그건 실패한 수정이니 원복해줘 꼭 그리고 기억해줘"
>
> "If code modification doesn't solve the problem, it's a failed modification → REVERT IT immediately and remember this principle"

### Failed Modifications (Reverted)

1. **viewer.html line 94**:
   - Changed: `width: 1920` → `width: 2000`
   - Reverted: ✅ Back to `width: 1920`

2. **chart_generator.py lines 378-386**:
   - Changed: Added `xref="paper"` to annotation.update()
   - Reverted: ✅ Back to original single-line update

---

## 📝 Current Status

### Completed Today
✅ Chart UI/UX improvements (from previous session):
   - Minimal spacing between subplots (0.02)
   - Conditional tick labels (edges only)
   - RXOUT label positioning (x=-0.08)
   - Colored title highlights (Band: blue, LNA: orange, Port: green)
   - Fixed KeyError for ANT2/ANTL missing data

### Deferred Issues
⏸️ **Screenshot Export Margin Issue**:
- Problem: RXOUT labels cropped in PNG export
- Status: Requires deeper investigation of Plotly export mechanism
- Notes: Simple width increase and xref change both failed
- Next approach: May need custom export logic or different positioning strategy

---

## 💡 Key Takeaways

1. **Always Revert Failed Changes**
   - If modification doesn't solve the problem → immediate rollback
   - Keep codebase clean from unsuccessful experiments
   - Document what was tried and why it failed

2. **Plotly Export Complexity**
   - `downloadImage()` behavior with negative coordinates is complex
   - Paper coordinates didn't solve the issue as expected
   - May require alternative approach (custom export, different positioning)

3. **Systematic Debugging**
   - User emphasized: "하나하나 가능성을 열어놓고 디버깅해보자"
   - Test each hypothesis thoroughly before moving to next
   - Don't accumulate failed code changes

---

## 📊 File Status

### Modified Files (Session Start → End)
- `viewer.html`: No net changes (reverted)
- `chart_generator.py`: No net changes (reverted)

### Current Working State
- Chart display: ✅ Working perfectly
- Filter functionality: ✅ Working
- Title highlighting: ✅ Working
- Screenshot export: ⚠️ Known issue (RXOUT labels cropped)

---

## 🔜 Next Steps (Future Session)

1. **Screenshot Export Investigation**:
   - Research Plotly's `toImage()` and `downloadImage()` internals
   - Test alternative annotation positioning strategies
   - Consider custom export implementation if needed
   - Explore Plotly forum/documentation for similar issues

2. **Potential Solutions to Test**:
   - Move RXOUT labels inside subplot area (positive x coordinates)
   - Use Y-axis titles instead of annotations
   - Implement custom screenshot logic with proper bounds
   - Use Plotly's `write_image()` server-side (kaleido/orca)

---

## 📌 Developer Notes

**Remember**: The principle of immediate rollback applies to ALL future development:
- Try solution → Test → If failed → Revert → Document
- Never leave failed experimental code in the codebase
- Each commit should represent working state

**Code Quality Rule**: "쓸데없이 우리의 코드를 복잡하기 만들지는 말자"
- Keep solutions simple and clean
- Remove unsuccessful attempts immediately
- Document reasoning for future reference

---

**Session End**: 2025-10-06
**Status**: Chart UI complete, export issue deferred for future investigation
