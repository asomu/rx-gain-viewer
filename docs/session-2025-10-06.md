# Session 2025-10-06: Chart Screenshot Export Issue Investigation

**Date**: 2025-10-06
**Duration**: ~30 minutes
**Focus**: Screenshot save margin issue debugging

---

## ğŸ¯ Session Goal

**User Issue**: "saveë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ì‚¬ì§„ì €ì¥í•  ë•Œ Rx Out1 ì´ìª½ì´ ë§ˆì§„ì´ ì—†ì–´ì„œ ì™¼ìª½ ë¶€ë¶„ì´ ì§¤ë¦°ë‹¤"

When using the "Save PNG" button in the chart viewer, RXOUT labels on the left side are being cropped/cut off in the exported image.

---

## ğŸ” Problem Analysis

### Current Chart Setup
- **Chart Size**: 1500px width Ã— 900px height
- **Left Margin**: 200px
- **RXOUT Label Position**: `x=-0.08` (8% left of subplot edge)
- **Export Settings**: `Plotly.downloadImage('chart', {format: 'png', width: 1920, height: 1200})`

### Root Cause Investigation

**Initial Hypothesis**: Export width too small
- Attempted: Increase width from 1920 to 2000px
- Result: âŒ Failed - Image scales proportionally, cropping position unchanged

**User Feedback**: "ë¹„ìœ¨ì— ë§ê²Œ ëŠ˜ì–´ë‚˜ê³  ì˜ë¦¬ëŠ” ìœ„ì¹˜ëŠ” ë³€ê²½ì´ ì—†ëŠ”ê²ƒ ê°™ì•„"

**Deeper Analysis**:
The real issue is that RXOUT annotations are positioned using:
- `x=-0.08` (negative coordinate = outside subplot domain)
- Default `xref='x domain'` (subplot-relative coordinates)
- Plotly's `downloadImage()` may not capture annotations outside subplot bounds

**Attempted Fix**: Change annotation `xref` to `'paper'`
- Rationale: Paper coordinates include margin area
- Implementation: Added `xref="paper"` to annotation.update()
- Result: âŒ Failed - Still cropped

---

## âš ï¸ Important Lesson Learned

**User's Critical Instruction**:
> "ì½”ë“œ ìˆ˜ì •í–ˆëŠ”ë° ë¬¸ì œ í•´ê²°ì•ˆë˜ë©´ ê·¸ê±´ ì‹¤íŒ¨í•œ ìˆ˜ì •ì´ë‹ˆ ì›ë³µí•´ì¤˜ ê¼­ ê·¸ë¦¬ê³  ê¸°ì–µí•´ì¤˜"
>
> "If code modification doesn't solve the problem, it's a failed modification â†’ REVERT IT immediately and remember this principle"

### Failed Modifications (Reverted)

1. **viewer.html line 94**:
   - Changed: `width: 1920` â†’ `width: 2000`
   - Reverted: âœ… Back to `width: 1920`

2. **chart_generator.py lines 378-386**:
   - Changed: Added `xref="paper"` to annotation.update()
   - Reverted: âœ… Back to original single-line update

---

## ğŸ“ Current Status

### Completed Today
âœ… Chart UI/UX improvements (from previous session):
   - Minimal spacing between subplots (0.02)
   - Conditional tick labels (edges only)
   - RXOUT label positioning (x=-0.08)
   - Colored title highlights (Band: blue, LNA: orange, Port: green)
   - Fixed KeyError for ANT2/ANTL missing data

### Deferred Issues
â¸ï¸ **Screenshot Export Margin Issue**:
- Problem: RXOUT labels cropped in PNG export
- Status: Requires deeper investigation of Plotly export mechanism
- Notes: Simple width increase and xref change both failed
- Next approach: May need custom export logic or different positioning strategy

---

## ğŸ’¡ Key Takeaways

1. **Always Revert Failed Changes**
   - If modification doesn't solve the problem â†’ immediate rollback
   - Keep codebase clean from unsuccessful experiments
   - Document what was tried and why it failed

2. **Plotly Export Complexity**
   - `downloadImage()` behavior with negative coordinates is complex
   - Paper coordinates didn't solve the issue as expected
   - May require alternative approach (custom export, different positioning)

3. **Systematic Debugging**
   - User emphasized: "í•˜ë‚˜í•˜ë‚˜ ê°€ëŠ¥ì„±ì„ ì—´ì–´ë†“ê³  ë””ë²„ê¹…í•´ë³´ì"
   - Test each hypothesis thoroughly before moving to next
   - Don't accumulate failed code changes

---

## ğŸ“Š File Status

### Modified Files (Session Start â†’ End)
- `viewer.html`: No net changes (reverted)
- `chart_generator.py`: No net changes (reverted)

### Current Working State
- Chart display: âœ… Working perfectly
- Filter functionality: âœ… Working
- Title highlighting: âœ… Working
- Screenshot export: âš ï¸ Known issue (RXOUT labels cropped)

---

## ğŸ”œ Next Steps (Future Session)

1. **Screenshot Export Investigation**:
   - Research Plotly's `toImage()` and `downloadImage()` internals
   - Test alternative annotation positioning strategies
   - Consider custom export implementation if needed
   - Explore Plotly forum/documentation for similar issues

2. **Potential Solutions to Test**:
   - Move RXOUT labels inside subplot area (positive x coordinates)
   - Use Y-axis titles instead of annotations
   - Implement custom screenshot logic with proper bounds
   - Use Plotly's `write_image()` server-side (kaleido/orca)

---

## ğŸ“Œ Developer Notes

**Remember**: The principle of immediate rollback applies to ALL future development:
- Try solution â†’ Test â†’ If failed â†’ Revert â†’ Document
- Never leave failed experimental code in the codebase
- Each commit should represent working state

**Code Quality Rule**: "ì“¸ë°ì—†ì´ ìš°ë¦¬ì˜ ì½”ë“œë¥¼ ë³µì¡í•˜ê¸° ë§Œë“¤ì§€ëŠ” ë§ì"
- Keep solutions simple and clean
- Remove unsuccessful attempts immediately
- Document reasoning for future reference

---

**Session End**: 2025-10-06
**Status**: Chart UI complete, export issue deferred for future investigation
