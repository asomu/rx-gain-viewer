{% extends 'rf_analyzer/base.html' %}

{% block title %}Grid Viewer - {{ session.name }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Sidebar: Filters -->
    <div class="col-md-3">
        <div class="card filter-sidebar">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üéõÔ∏è Filters</h5>
            </div>
            <div class="card-body">
                <!-- Session Info -->
                <div class="mb-3">
                    <h6 class="text-muted">Session</h6>
                    <p class="mb-0"><strong>{{ session.name }}</strong></p>
                    <small class="text-muted">{{ session.created_at|date:"Y-m-d H:i" }}</small>
                </div>

                <hr>

                <!-- Band Filter -->
                <div class="mb-3">
                    <label class="form-label"><strong>Band</strong></label>
                    <select class="form-select" id="bandSelect">
                        {% for band in bands %}
                            <option value="{{ band }}" {% if band == selected_band %}selected{% endif %}>
                                {{ band }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- LNA Gain State Filter -->
                <div class="mb-3">
                    <label class="form-label"><strong>LNA Gain State</strong></label>
                    <select class="form-select" id="lnaSelect">
                        {% for lna in lna_states %}
                            <option value="{{ lna }}" {% if lna == selected_lna %}selected{% endif %}>
                                {{ lna }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Input Port Filter -->
                <div class="mb-3">
                    <label class="form-label"><strong>Input Port</strong></label>
                    <select class="form-select" id="portSelect">
                        {% for port in input_ports %}
                            <option value="{{ port }}" {% if port == selected_port %}selected{% endif %}>
                                {{ port }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <hr>

                <!-- Export Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger" id="exportPdfBtn">
                        üìÑ Export PDF
                    </button>
                    <button class="btn btn-outline-warning" id="exportFullReportPdfBtn">
                        üìë Full Report PDF
                    </button>
                    <button class="btn btn-outline-success" id="exportPptBtn">
                        üìä Export PPT
                    </button>
                </div>

                <hr>

                <!-- Data Info -->
                <div class="small text-muted">
                    <p class="mb-1">
                        <strong>Total Points:</strong> {{ session.data_points.count }}
                    </p>
                    <p class="mb-0">
                        <strong>Bands:</strong> {{ bands|length }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right: Chart Container -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    üìà Grid Chart: {{ selected_band }} / {{ selected_lna }} / {{ selected_port }}
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="Plotly.downloadImage('chart', {format: 'png', width: 1920, height: 1200, filename: 'grid_chart'})">
                        üíæ Save PNG
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Chart will be loaded here -->
                <div id="chart" style="width: 100%; height: 800px;">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading chart data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div id="progressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%;">
        <h3 style="margin-top: 0;">Generating Full Report PDF</h3>

        <!-- Progress Bar -->
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 30px; margin: 20px 0; overflow: hidden;">
            <div id="progressBar" style="width: 0%; background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                <span id="progressPercent">0%</span>
            </div>
        </div>

        <!-- Progress Info -->
        <div id="progressInfo" style="margin: 15px 0; font-size: 14px;">
            <div><strong>Status:</strong> <span id="progressStatus">Initializing...</span></div>
            <div><strong>Progress:</strong> <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> pages</div>
            <div><strong>Current:</strong> <span id="progressCurrentItem">-</span></div>
            <div><strong>Elapsed:</strong> <span id="progressElapsed">0s</span></div>
            <div><strong>Estimated Remaining:</strong> <span id="progressETA">Calculating...</span></div>
        </div>

 <!-- Message -->
        <div id="progressMessage" style="padding: 10px; background: #f5f5f5; border-radius: 5px; margin: 10px 0; font-size: 13px;"></div>

        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button id="progressCancelBtn" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button id="progressCloseBtn" style="display: none; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Close</button>
        </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Load chart on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadChart();
    });

    function loadChart() {
        const band = document.getElementById('bandSelect').value;
        const lna = document.getElementById('lnaSelect').value;
        const port = document.getElementById('portSelect').value;
        const sessionId = {{ session.id }};

        // Show loading spinner
        const chartDiv = document.getElementById('chart');
        chartDiv.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Generating chart for ${band} / ${lna} / ${port}...</p>
            </div>
        `;

        // Call chart API
        fetch(`/rf-analyzer/api/chart/${sessionId}/?band=${band}&lna=${lna}&port=${port}`)
            .then(response => response.json())
            .then(data => {
                    // Clear loading spinner first
                    chartDiv.innerHTML = "";
                if (data.success) {
                    // Parse Plotly JSON and render chart
                    const chartData = JSON.parse(data.chart);
                    Plotly.newPlot('chart', chartData.data, chartData.layout, {responsive: true});

                    console.log(`Chart loaded: ${data.data_points} data points`);
                } else {
                    chartDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${data.error || 'Failed to load chart'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Chart loading error:', error);
                chartDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> Failed to load chart. ${error.message}
                    </div>
                `;
            });
    }

    // Update chart when filters change
    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', loadChart);
    });

    // PDF Export button
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
        const band = document.getElementById('bandSelect').value;
        const lna = document.getElementById('lnaSelect').value;
        const port = document.getElementById('portSelect').value;
        const sessionId = {{ session.id }};

        // Open PDF export URL in new tab (triggers download)
        const url = `/rf-analyzer/api/export-pdf/${sessionId}/?band=${band}&lna=${lna}&port=${port}`;
        window.open(url, '_blank');
    });

    // Full Report PDF Export button with real-time progress via SSE
    document.getElementById('exportFullReportPdfBtn').addEventListener('click', function() {
        const sessionId = {{ session.id }};
        const button = this;

        // Show progress modal
        const modal = document.getElementById('progressModal');
        modal.style.display = 'flex';

        // Reset progress UI
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressPercent').textContent = '0%';
        document.getElementById('progressStatus').textContent = 'Starting...';
        document.getElementById('progressCurrent').textContent = '0';
        document.getElementById('progressTotal').textContent = '0';
        document.getElementById('progressCurrentItem').textContent = '-';
        document.getElementById('progressElapsed').textContent = '0s';
        document.getElementById('progressETA').textContent = 'Calculating...';
        document.getElementById('progressMessage').textContent = 'Initializing PDF generation...';
        document.getElementById('progressCloseBtn').style.display = 'none';

        // Disable button
        button.disabled = true;
        button.innerHTML = 'Generating... See progress modal';

        // Start PDF generation in background
        const generateUrl = `/rf-analyzer/api/export-full-report-pdf/${sessionId}/`;
        fetch(generateUrl)
            .then(response => response.blob())
            .then(blob => {
                // Auto-download when complete
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `full_report_${sessionId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();
            })
            .catch(error => {
                console.error('PDF download error:', error);
                document.getElementById('progressMessage').textContent = 'Error downloading PDF: ' + error.message;
            });

        // Connect to SSE stream for real-time updates
        const sseUrl = `/rf-analyzer/api/progress-stream/${sessionId}/`;
        const eventSource = new EventSource(sseUrl);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.status === 'waiting') {
                document.getElementById('progressStatus').textContent = 'Waiting...';
                document.getElementById('progressMessage').textContent = data.message;
            } else if (data.status === 'running') {
                // Update progress bar
                document.getElementById('progressBar').style.width = data.percentage + '%';
                document.getElementById('progressPercent').textContent = data.percentage + '%';

                // Update info
                document.getElementById('progressStatus').textContent = 'Processing...';
                document.getElementById('progressCurrent').textContent = data.current;
                document.getElementById('progressTotal').textContent = data.total;
                document.getElementById('progressCurrentItem').textContent = data.current_item;
                document.getElementById('progressElapsed').textContent = data.elapsed_time + 's';
                document.getElementById('progressETA').textContent = data.estimated_remaining + 's (' + Math.round(data.estimated_remaining / 60) + ' min)';
                document.getElementById('progressMessage').textContent = data.message;
            } else if (data.status === 'completed') {
                // Completed
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressPercent').textContent = '100%';
                document.getElementById('progressStatus').textContent = 'Complete!';
                document.getElementById('progressMessage').textContent = data.message + ' - PDF download will start automatically.';
                document.getElementById('progressCloseBtn').style.display = 'block';
                document.getElementById('progressETA').textContent = '0s';

                eventSource.close();

                // Re-enable button
                button.disabled = false;
                button.innerHTML = 'üìë Full Report PDF';
            } else if (data.status === 'cancelled') {
                // Cancelled
                document.getElementById('progressStatus').textContent = 'Cancelled';
                document.getElementById('progressMessage').textContent = data.message || 'Task cancelled by user';
                document.getElementById('progressCloseBtn').style.display = 'block';
                document.getElementById('progressCancelBtn').style.display = 'none';

                eventSource.close();

                // Re-enable button
                button.disabled = false;
                button.innerHTML = 'üìë Full Report PDF';                
            } else if (data.status === 'failed') {
                // Failed
                document.getElementById('progressStatus').textContent = 'Failed';
                document.getElementById('progressMessage').textContent = 'Error: ' + data.message;
                document.getElementById('progressCloseBtn').style.display = 'block';

                eventSource.close();

                // Re-enable button
                button.disabled = false;
                button.innerHTML = 'üìë Full Report PDF';
            } else if (data.status === 'done') {
                eventSource.close();
            }
        };

        eventSource.onerror = function(error) {
            console.error('SSE Error:', error);
            document.getElementById('progressMessage').textContent = 'Connection error - please refresh the page';
            eventSource.close();
        };

        // Close modal button
        document.getElementById('progressCloseBtn').onclick = function() {
            modal.style.display = 'none';
        };
        
        // Cancel button
        document.getElementById('progressCancelBtn').onclick = function() {
            if (confirm('Are you sure you want to cancel PDF generation?')) {
                fetch(`/rf-analyzer/api/cancel-task/${sessionId}/`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('progressMessage').textContent = 'Cancellation requested...';
                        document.getElementById('progressCancelBtn').disabled = true;
                    })
                    .catch(error => {
                        console.error('Cancel error:', error);
                        alert('Failed to cancel task');
                    });
            }
        };        
    });

    document.getElementById('exportPptBtn').addEventListener('click', function() {
        alert('PPT export coming soon!');
    });
</script>
{% endblock %}
